class ChatEmotes{chatSettings=defaultVisualSettings.chat;constructor(e=defaultVisualSettings.chat){this.chatSettings=e}}const _win=window.parent.window;let chatEmotes=void 0,isLoaded=!1,_loadTimer=void 0;console.log("chat/emotes: load"),console.log(window.location.href),console.log(_win.location.href),location.href="javascript:console.log(document.querySelector('yt-live-chat-item-list-renderer'.emojiManager); void 0";const load=()=>{clearTimeout(_loadTimer),isLoaded||setTimeout(()=>{_win.dispatchEvent(new Event("chat.emotes.getSettings")),load()},500)},getEmojiManager=()=>{console.log("getEmojiManager");var e=document.querySelector("yt-live-chat-item-list-renderer");console.log(e),null!=e?"emojiManager"in e?console.log("emojiManager",e.emojiManager):console.warn("Cannot find emojiManager"):console.warn("Cannot find chat list")};_win.addEventListener("chat.emotes.settings",e=>{e=e.detail.chat??defaultVisualSettings.chat;console.log("chat.emotes.settings",e),void 0===chatEmotes?chatEmotes=new ChatEmotes(e):chatEmotes.chatSettings=e,isLoaded=!0,clearTimeout(_loadTimer),getEmojiManager()}),_win.addEventListener("chat.emotes.getEmojiManager",()=>{console.log("chat.emotes.getEmojiManager"),getEmojiManager()}),load(),function(){const t=/https:\/\/www\.youtube\.com/i,o=/https:\/\/www\.youtube\.com\/live_chat\?continuation=/i,s=visualSettingsKey,d=new Emotes,a=new Set;let r=!1,u=!1,i=!1,c=!0,l=void 0,h=void 0,g={...defaultVisualSettings},y=void 0,m=!1,v={...defaultChatElements},p=[],w=0,b=[],f=[],n="",E=!1;const S=()=>Utils.canRun(o,document.location.href);const x=()=>{if(!(()=>{if(!Utils.exists(window.parent)||!Utils.exists(window.parent.window))return!1;const e=window.parent.window;var t=document.querySelector("yt-live-chat-app"),o=e.document.querySelector("ytd-live-chat-frame");return Utils.exists(t)||Utils.exists(o)})())return"";var e=document.querySelector("ytd-channel-name > #container > #text-container > yt-formatted-string > a");return Utils.exists(e)?e.innerText:""},U=()=>{const t=x().toLowerCase();var e=supportedChannels.find(e=>e.youtube.name===t);return Utils.exists(e)&&!e.youtube.enable},A=(i=null,e=!1)=>{if(!Utils.exists(i)||!u)return i;e&&i.setAttribute("ytg-hidden","");var t=i.tagName,o=i.hasAttribute("is-deleted");const n=i.querySelector("#content");e="YT-LIVE-CHAT-MEMBERSHIP-ITEM-RENDERER"===t||"YT-LIVE-CHAT-PAID-MESSAGE-RENDERER"===t||"YT-LIVE-CHAT-VIEWER-ENGAGEMENT-MESSAGE-RENDERER"===t||"YTD-SPONSORSHIPS-LIVE-CHAT-GIFT-REDEMPTION-ANNOUNCEMENT-RENDERER"===t||i.hasAttribute("show-only-header");if("YT-LIVE-CHAT-TEXT-MESSAGE-RENDERER"!==t&&!e||i.hasAttribute("ytg-checked"))return i.removeAttribute("ytg-hidden"),i.setAttribute("ytg-checked",""),i;if(g.chat.separatedLines&&(E&&i.setAttribute("ytg-chat-alt",""),E=!E),g.chat.showDeleted&&!e){o&&(i.removeAttribute("is-deleted"),i.setAttribute("ytg-deleted",""));const s=new MutationObserver(e=>{for(const o of e)if("attributes"===o.type){const n=o.target;var t;Utils.exists(n)&&n.hasAttribute("is-deleted")&&(u&&(i.removeAttribute("is-deleted"),i.setAttribute("ytg-deleted","")),s&&(-1<(t=b.indexOf(s))&&b.splice(t,1),s.disconnect()))}});s.observe(i,{attributes:!0}),b.push(s);const r=setTimeout(()=>{var e;void 0!==s&&(-1<(e=b.indexOf(s))&&b.splice(e,1),s.disconnect()),void 0!==r&&(-1<(e=f.indexOf(r))&&f.splice(e,1),clearTimeout(r))},6e4);f.push(r)}if(Utils.exists(n)){const a=n.querySelector("yt-live-chat-author-chip > #author-name");t=n.querySelector("#message"),o=Math.round((new Date).getTime()/1e3);if(g.chat.nameColor&&Utils.exists(a)&&!e){const c=a.innerText.trim().toLowerCase(),l=p.find(e=>e.name===c);let e=Utils.generatePastelColor();null==l?p.push({color:e,name:c,ts:o}):(e=l.color,l.ts=o),a.style.setProperty("color",e,"important")}(g.chat.bttvEmotes||g.chat.ffzEmotes)&&d.insertTo(t)}return i.setAttribute("ytg-checked",""),i},L=(e=950)=>{clearTimeout(y);var t=100*a.size,t=Utils.randomInt(t<750?750:t,2e3),t=t<2e3?t:2e3;if(Utils.exists(v.target)&&i&&0<a.size){m=!0;const n=new Set([...a]);a.clear(),m=!1;var o=Math.round(t/(0<n.size?n.size:1)-100);for(let e of n.values()){if(!u)break;Utils.exists(e)&&(isFinite(o)&&n.size<3?setTimeout(()=>{u&&e.removeAttribute("ytg-hidden")},o):e.removeAttribute("ytg-hidden"))}}M(e)},M=(e=950)=>{clearTimeout(y),g.chat.simulatedDelay&&(y=setTimeout(()=>L(e),e))},T=(e=!0,t=!1)=>{clearInterval(l),clearTimeout(y),a.clear(),void 0!==R&&R.disconnect(),void 0!==I&&I.disconnect(),O&&O.disconnect(),void 0!==q&&q.disconnect(),void 0!==j&&j.disconnect(),d.emojiPickerObserver&&d.emojiPickerObserver.disconnect(),0<b.length&&(b.every(e=>!!u&&(void 0===e&&e.disconnect(),!0)),b.length=0),0<f.length&&(f.every(e=>!!u&&(void 0===e&&clearTimeout(e),!0)),f.length=0),e&&B(t)},C=new MutationObserver(e=>{for(const o of e){var t;"attributes"===o.type&&("is-two-columns_"==o.attributeName?(t=o.target,Utils.exists(t)&&u&&T(!0)):"style"==o.attributeName&&resetVideoSize())}}),R=new MutationObserver((e,t)=>{for(const o of e.filter(e=>"items"===e.target.id).filter(e=>0<e.addedNodes.length))if(void 0!==o&&0!==o.addedNodes.length)for(const n of o.addedNodes)Utils.exists(n)&&u&&(g.chat.simulatedDelay&&!m?(a.add(A(n,!0)),15<=a.size&&L()):A(n))}),I=new MutationObserver((e,t)=>{T(!0)}),j=new MutationObserver(e=>{for(const o of e){var t;"attributes"===o.type&&(t=o.target,Utils.exists(t)&&u&&T(!0))}}),O=new MutationObserver(e=>{for(const o of e){var t;"attributes"===o.type&&(t=o.target,Utils.exists(t)&&u&&T(!0))}}),q=new MutationObserver(e=>{var e=e.find(e=>Utils.exists(e));Utils.exists(e)&&(e=e.target,Utils.exists(e)&&Utils.exists(v.innerBody)&&u&&d.injectSuggestions(v,e.textContent))}),B=(r=!1)=>{clearInterval(l),clearTimeout(y),l=setInterval(()=>{if(u&&(v.app=document.querySelector("yt-live-chat-app"),Utils.exists(v.app))){if(window.parent.window.addEventListener("updateChatCollapsed",e=>{var t=e.detail.collapsed;console.log("window.parent updateChatCollapsed",e,t),N(t)}),window.addEventListener("updateChatCollapsed",e=>{var t=e.detail.collapsed;console.log("window updateChatCollapsed",e,t),N(t)}),v.innerBody=v.app.closest("body"),r&&g.showReplayChat&&v.app.hasAttribute("collapsed")){const o=v.app.querySelector("#show-hide-button > ytd-toggle-button-renderer > a.yt-simple-endpoint");Utils.exists(o)&&o.click()}if(Utils.exists(v.innerBody)&&(v.target=v.innerBody.querySelector("#items.yt-live-chat-item-list-renderer"),Utils.exists(v.target))){window.addEventListener("yt-live-chat-item-list-renderer",e=>{console.log("yt-live-chat-item-list-renderer",e)}),window.addEventListener("handleAddChatItemAction_",e=>{console.log("handleAddChatItemAction_",e)}),v.target.addEventListener("handleAddChatItemAction_",e=>{console.log("handleAddChatItemAction_",e)}),window.addEventListener("yt-live-chat-text-input-field-renderer",e=>{console.log("yt-live-chat-text-input-field-renderer",e)}),window.addEventListener("calculateLiveChatRichMessageInput_",e=>{console.log("calculateLiveChatRichMessageInput_",e)}),window.addEventListener("yt-live-chat-renderer",e=>{console.log("yt-live-chat-renderer",e)}),window.addEventListener("preprocessActions_",e=>{console.log("preprocessActions_",e)});const n=()=>{const t=document.querySelector("yt-live-chat-item-list-renderer");null!=t?"emojiManager"in t?t.emojiManager._ytg||(t.emojiManager._ytg=!0,t.emojiManager.load([...e.values()])):console.warn("Cannot find emojiManager"):console.warn("Cannot find chat list")};window.addEventListener("emotes",e=>{console.log("window.on(emotes)",e),n()}),window.parent.window.addEventListener("emotes",e=>{console.log("window.parent.window.on(emotes)",e),n()});const i=v.innerBody.querySelector("yt-live-chat-participant-list-renderer");if(k(),clearInterval(l),clearTimeout(y),a.clear(),v.dropdown=v.innerBody.querySelector(".yt-live-chat-header-renderer > yt-dropdown-menu > tp-yt-paper-menu-button > tp-yt-iron-dropdown tp-yt-paper-listbox"),Utils.exists(v.dropdown)&&(c&&(v.modes=v.dropdown.querySelectorAll("a"),Utils.exists(v.modes)&&2<=v.modes.length&&(!0===v.modes[1].getAttribute("aria-selected")&&"true"===v.modes[1].getAttribute("aria-selected")||v.modes[1].click()),c=!1),I.observe(v.dropdown,{attributes:!0,characterData:!0,childList:!0,subtree:!0,attributeOldValue:!0,characterDataOldValue:!0})),Utils.exists(i)&&O.observe(i,{attributes:!0}),!Utils.exists(i)||i.hasAttribute("disable-upgrade")){const s=[...v.target.children];s.every(e=>!!u&&(Utils.exists(e)&&A(e),!0)),R.observe(v.target,{childList:!0,subtree:!0});var t=v.target.querySelector("#show-more.yt-live-chat-item-list-renderer");Utils.exists(t)?j.observe(t,{attributes:!0}):void 0!==j&&j.disconnect(),g.chat.simulatedDelay&&M(),void 0===h&&(h=setInterval(()=>{const t=p.length;let o=[...p];w!==t&&Storage.getLocalBytesInUse(chatUsersKey).then(e=>{98<=(e/4e6*100).toFixed(2)&&(e=Math.round(.1*o.length),o.sort((e,t)=>e.ts-t.ts).splice(0,e),console.info(`filtered out ${t-o.length} inactive chatUsers!`),alert(`filtered out ${t-o.length} inactive chatUsers!`))}).catch(e=>console.error("saveChatUsers getLocalBytesInUse",e)).finally(()=>{const e=o.length;Storage.setLocal(chatUsersKey,o).then(()=>w=e).catch(e=>console.error("saveChatUsers setLocal",chatUsersKey,e))})},1e4)),v.textInputFieldRenderer=v.innerBody.querySelector("yt-live-chat-text-input-field-renderer"),v.inputRenderer=v.innerBody.querySelector("yt-live-chat-message-input-renderer yt-live-chat-text-input-field-renderer"),Utils.exists(v.inputRenderer)&&(v.inputField=v.inputRenderer.querySelector("#input"),Utils.exists(v.inputRenderer)&&(v.ironDropdown=v.inputRenderer.querySelector("tp-yt-iron-dropdown"),Utils.exists(v.ironDropdown)&&(v.dropdownContent=v.ironDropdown.querySelector(".dropdown-content.yt-live-chat-text-input-field-renderer"))),Utils.exists(v.inputField)?q.observe(v.inputField,{characterData:!0,subtree:!0}):void 0!==q&&q.disconnect())}(g.chat.bttvEmotes||g.chat.ffzEmotes)&&(t=v.innerBody.querySelector("yt-emoji-picker-renderer.yt-live-chat-message-input-renderer"),Utils.exists(t)&&d.emojiPickerObserver.observe(t,{attributes:!0}))}}},500)},N=e=>{Utils.exists(document.body)&&(e?document.body.hasAttribute("ytg-hide-chat")||document.body.setAttribute("ytg-hide-chat",""):document.body.hasAttribute("ytg-hide-chat")&&document.body.removeAttribute("ytg-hide-chat"))},D=()=>{0===p.length?Storage.getLocal(chatUsersKey,p).then(e=>{const t=[...e],o=0<t.length?new Set(t.map(e=>e.name)):new Set;p=[...t,...p.filter(e=>!o.has(e.name))],w=p.length}).catch(e=>{console.error("Storage.getLocal",chatUsersKey,e)}).finally(()=>T(!0,!0)):T(!0,!0)},_=()=>{u&&(i="visible"===document.visibilityState)},k=()=>{Utils.exists(v.innerBody)&&(v.innerBody.hasAttribute("ytg-plus")||v.innerBody.setAttribute("ytg-plus",""),g.chat.icon||v.innerBody.hasAttribute("ytg-no-avatar")||v.innerBody.setAttribute("ytg-no-avatar",""))},V=()=>{v.app=document.querySelector("yt-live-chat-app"),Utils.exists(v.app)&&(Utils.exists(v.innerBody)||(v.innerBody=v.app.closest("body")),Utils.exists(v.innerBody)&&(v.innerBody.hasAttribute("ytg-plus")&&v.innerBody.removeAttribute("ytg-plus"),v.innerBody.hasAttribute("ytg-no-avatar")&&v.innerBody.removeAttribute("ytg-no-avatar")))},P=()=>{void 0!==J&&J.disconnect(),Utils.exists(document.body)&&!document.body.hasAttribute("ytg-plus")&&(document.body.setAttribute("ytg-plus",""),console.log("[YouTubeGaming+] Added: chat page attribute!"))},z=()=>{V(),void 0!==J&&J.disconnect(),Utils.exists(document.body)&&document.body.hasAttribute("ytg-plus")&&(document.body.removeAttribute("ytg-plus"),console.log("[YouTubeGaming+] Removed: chat page attribute!"))},G=()=>{const e=document.head||document.documentElement;Utils.exists(e)&&(Utils.exists(e.querySelector("link#ytg-plus-chat"))||(e.insertAdjacentHTML("beforeend",'<link rel="stylesheet" type="text/css"  id="ytg-plus-chat" href="'+chrome.runtime.getURL("styles/ytg-plus-chat.min.css")+'" />'),console.log("[YouTubeGaming+] Loaded: chat styles!")))},Y=()=>{chrome.runtime.sendMessage({type:"youtubegaming+",system:"general",action:"executeScript",files:["src/chat/emotesInjected.min.js"]},e=>{console.log(e),console.log("[YouTubeGaming+] Loaded: chat scripts!")})},F=()=>{c=!0,v={target:document.createElement("div"),innerBody:void 0,dropdown:void 0,modes:void 0,inputRenderer:void 0,inputField:void 0,ironDropdown:void 0,dropdownContent:void 0},d.chatSettings=g.chat,d.load(n,v),console.log("-- yt-live-chat-item-list-renderer --"),console.log(document.querySelector("yt-live-chat-item-list-renderer")),document.addEventListener("visibilitychange",_);var e=document.querySelector("ytd-page-manager > ytd-watch-flexy");Utils.exists(e)&&C.observe(e,{attributes:!0}),window.addEventListener("yt-live-chat-select-suggestion",e=>{console.log("yt-live-chat-select-suggestion"),console.log(e)}),g.theatreMode&&P(),g.chat.icon||Utils.exists(document.body)&&!document.body.hasAttribute("ytg-no-avatar")&&document.body.setAttribute("ytg-no-avatar",""),T(!0),D(),window.dispatchEvent(new Event("resize")),U()?(u=!1,K(),$(),z()):Y()},H=()=>{if(console.log("chat load",S(),u),u){if(r)F();else{if(U())return u=!1,K(),$(),z(),!1;Storage.getSync(s,JSON.stringify(g)).then(e=>{r=!0,g={...g,...e},d.chatSettings=g.chat}).catch(e=>{console.error("Storage.getSync",s,e)}).finally(()=>{window.addEventListener("chat.emotes.getSettings",()=>{console.log("chat.emotes.getSettings"),window.dispatchEvent(new CustomEvent("chat.emotes.settings",{detail:{chat:g.chat},bubbles:!0}))}),window.addEventListener("chat.emotes.emojiManager",e=>{console.log("chat.emotes.emojiManager",e.detail)}),window.dispatchEvent(new Event("chat.emotes.getEmojiManager")),F()})}return void 0!==J&&J.disconnect(),!0}return!1},J=new MutationObserver(e=>{e.some(()=>{if(S())return J.disconnect(),H()})}),K=()=>{void 0!==J&&J.disconnect(),void 0!==C&&C.disconnect(),T(!1)},$=()=>{clearInterval(l),clearInterval(h),clearTimeout(y),a.clear()},W=()=>{Utils.canRun(t,document.location.href)&&(u=!1,a.clear(),$(),K(),G(),setTimeout(()=>{(()=>{if(console.log("chat checkPage",S()),!S())return u=!1,K(),$();u=!0,i="visible"===document.visibilityState,G(),H()||J.observe(document.documentElement,{attributes:!0,characterData:!0,childList:!0,subtree:!0,attributeOldValue:!0,characterDataOldValue:!0})})()},500))};window.onload=W,window.addEventListener("yt-navigate-start",W,!0),chrome.runtime.onMessage.addListener((t,e,o)=>{if(S()&&t.type&&"youtubegaming+"===t.type&&t.system)if("background"===t.system)t.action&&"urlChange"===t.action?(z(),W()):t.action&&"initialLoad"===t.action?(r=!1,t.data.visualSettings&&(g={...g,...JSON.parse(JSON.stringify(t.data.visualSettings))},d.chatSettings=g.chat),z(),W()):t.action&&"extensionUpdate"===t.action?(console.log(t.data),console.log(t.data.previousVersion),console.log(t.data.currentVersion)):t.action&&"unknown"===t.action&&(console.log(t),console.log(t.data));else if("settings"===t.system){if(t.action&&"getSync"===t.action){const n=JSON.stringify(t.data)??JSON.stringify({});return Storage.getSync(t.key??"",n).then(e=>(o({success:!0,data:e}),!0)).catch(e=>(console.error("request.getSync",t.key,e),o({success:!1,data:n}),!0))}if(t.action&&"setSync"===t.action){const i=t.data??JSON.stringify({});return Storage.setSync(t.key??"",i).then(()=>(o({success:!0,data:i}),!0)).catch(e=>(console.error("request.setSync",t.key,e),o({success:!1,data:i}),!0))}}}),chrome.storage.onChanged.addListener((e,t)=>{for(var[o,{oldValue:n,newValue:i}]of Object.entries(e))if(o===s){if(r=!1,!S())return;console.log("chrome.storage.onChanged"),console.log(n),console.log(i),g={...g,...i},d.chatSettings=g.chat,z(),W()}})}();