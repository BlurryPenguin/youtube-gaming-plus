'use strict';
(function () {
	function t(t) {
		if (((u = !1), r.test(t))) return (u = !0), !0;
		if (l.test(t)) return !1;
		if (h.test(t)) {
			var e = t.toLowerCase().split('/');
			return (
				(!e[2] || 'www.smashcast.tv' === e[2]) &&
				e.length > 2 &&
				e.length < 6 &&
				('settings' === e[3] ||
					'embed' === e[3] ||
					'browse' === e[3] ||
					'channels' === e[3] ||
					'games' === e[3] ||
					'admin' === e[3] ||
					'esports' === e[3] ||
					'foryou' === e[3] ||
					'content' === e[3] ||
					'legal' === e[3] ||
					'api' === e[3] ||
					'broadcast-tools' === e[3] ||
					'community' === e[3] ||
					'studio' === e[3] ||
					'' === e[3] ||
					('embedchat' !== e[3] && 4 !== e.length) ||
					('embedchat' === e[3] && (m = !0), (u = !0), !0))
			);
		}
		return !1;
	}
	function e(t, e) {
		(this.window = t),
			(this.document = e),
			(this.chatAddonSettings = {}),
			(this.generalSettings = {}),
			(this.defaultGeneralSettings = { darkTheme: !1, userName: '', nameColor: '208efc' }),
			(this.defaultChatSettings = {
				Highlight: { tab: !1, back: !1, text: !1, additional: '' },
				Notify: !1,
				HideImages: !1,
			}),
			(this.url = e.location.href),
			(this.customHightlight = !0),
			(this.hideImages = !1),
			(this.lastMessageIndex = 0),
			(this.lastMessages = []),
			(this.session = {}),
			(this.userName = ''),
			(this.nameColor = ''),
			(this.chatPosition = 'right'),
			(this.hexNameColor = { r: 148, g: 187, b: 34 }),
			(this.highlightType = 'none'),
			(this.lstTriggers = []),
			(this.chatInput = null),
			(this.nameSelectType = 2),
			(this.elements = { chat: null, leftColumn: null, tseScrollbar: null, chatResizer: null }),
			(this.Notification = t.Notification),
			(this.sessionTries = 0),
			(this.lastSave = ((+new Date() / 1e3) | 0) - 5),
			(this.lastSession = ((+new Date() / 1e3) | 0) - 5),
			(this.startTime = ((+new Date() / 1e3) | 0) + 5);
	}
	function i(t) {
		return t < 10 ? '0' + t : t;
	}
	function s(t) {
		var e = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(t);
		return e ? { r: parseInt(e[1], 16), g: parseInt(e[2], 16), b: parseInt(e[3], 16) } : { r: 148, g: 187, b: 34 };
	}
	function n(t, e) {
		t = t.toLowerCase();
		for (var i = !1, s = 0; s < e.length; s++)
			if (t === e[s].toLowerCase()) {
				i = !0;
				break;
			}
		return i;
	}
	function a() {
		(o = !!t(document.location.href)), o === !0 && (null === d ? ((d = new e(window, document)), d.load()) : d.load());
	}
	var o = !0,
		h = /https:\/\/www.youtube.com\/watch?v=(.*?)/i,
		r = /https:\/\/www.smashcast.tv\/studio\/(.*?)\/live/i,
		l = /https:\/\/www.smashcast.tv\/api/i,
		g = 'smashcastPlus.generalSettings',
		c = 'smashcastPlus.chatSettings',
		d = null,
		m = !1,
		u = !1;
	(o = !!t(document.location.href)),
		(e.prototype.load = function (e) {
			var i = this;
			(this.url = this.document.location.href),
				(o = !!t(this.url)),
				void 0 === e || null === e
					? (chrome.storage.sync.get(g, function (t) {
							null === t
								? (i.generalSettings = i.defaultGeneralSettings)
								: void 0 !== t[g] && null !== t[g]
								? (i.generalSettings = t[g])
								: (i.generalSettings = i.defaultGeneralSettings),
								i.generalSettings.darkTheme && (i.darkTheme = i.generalSettings.darkTheme),
								i.generalSettings.userName &&
									'' !== i.generalSettings.userName &&
									(i.userName = i.generalSettings.userName),
								i.generalSettings.nameColor &&
									'' !== i.generalSettings.nameColor &&
									((i.nameColor = i.generalSettings.nameColor),
									(i.hexNameColor = s('#' + i.generalSettings.nameColor)));
					  }),
					  chrome.storage.sync.get(c, function (t) {
							null === t
								? i.load(i.defaultChatSettings)
								: void 0 !== t[c] && null !== t[c]
								? i.load(t[c])
								: i.load(i.defaultChatSettings);
					  }))
					: ((this.chatAddonSettings = e),
					  (this.lstTriggers = []),
					  void 0 !== this.chatAddonSettings.Highlight &&
							(void 0 !== this.chatAddonSettings.Highlight.tab &&
								this.chatAddonSettings.Highlight.tab &&
								(this.customHightlight = !0),
							void 0 !== this.chatAddonSettings.Highlight.back &&
								this.chatAddonSettings.Highlight.back &&
								(this.customHightlight = !0),
							void 0 !== this.chatAddonSettings.Highlight.text &&
								this.chatAddonSettings.Highlight.text &&
								(this.customHightlight = !0),
							void 0 !== this.userName &&
								'' !== this.userName &&
								(this.lstTriggers.push(this.userName.toLowerCase()),
								this.lstTriggers.push('@' + this.userName.toLowerCase())),
							void 0 !== this.chatAddonSettings.Highlight.additional &&
								this.chatAddonSettings.Highlight.additional.split(',').forEach(function (t) {
									if (void 0 !== t && null !== t && '' !== t && ',' !== t) {
										var e = t.toLowerCase();
										i.lstTriggers.indexOf(e) < 0 && i.lstTriggers.push(e);
									}
								}, this)),
					  void 0 !== this.chatAddonSettings.HideImages &&
							this.chatAddonSettings.HideImages === !0 &&
							(this.hideImages = !0),
					  (this.startTime = ((+new Date() / 1e3) | 0) + 5),
					  i.loadSession(),
					  i.chatChecks());
		}),
		(e.prototype.save = function () {
			var t = (+new Date() / 1e3) | 0;
			if (t - this.lastSave >= 5) {
				if (
					((this.lastSave = t),
					'' !== this.userName && (this.generalSettings.userName = this.userName.toString()),
					'' !== this.nameColor && (this.generalSettings.nameColor = this.nameColor.toString()),
					void 0 !== this.generalSettings && null !== this.generalSettings)
				) {
					var e = {};
					(e[g] = this.generalSettings), chrome.storage.sync.set(e);
				}
				if (null !== this.chatAddonSettings && void 0 !== this.chatAddonSettings.Highlight) {
					var i = {};
					(i[c] = this.chatAddonSettings), chrome.storage.sync.set(i);
				}
			}
		}),
		(e.prototype.loadSession = function () {
			var t = (+new Date() / 1e3) | 0;
			if (t - this.lastSession >= 2) {
				var e = this;
				this.lastSession = t;
				var i = window.localStorage,
					n = i.getItem('ls/smashcast.session');
				if (void 0 !== n && null !== n) {
					(this.session = JSON.parse(n)), this.session.user_name && (this.userName = this.session.user_name.toString());
					var a = i.getItem('ls/chat.chatOptions.nameColor').replace(/^"(.*)"$/, '$1');
					void 0 !== a && null !== a && ((this.nameColor = a.toString()), (this.hexNameColor = s('#' + a.toString()))),
						(this.generalSettings.userName === this.userName && this.generalSettings.nameColor === this.nameColor) ||
							this.save(),
						(this.sessionTries = 0);
				} else
					this.sessionTries < 10 &&
						setTimeout(function () {
							e.sessionTries++, e.loadSession();
						}, 2e3);
			}
		}),
		(e.prototype.chatChecks = function () {
			var t = this;
			if (o && u) {
				if (
					((this.chatBody = this.document.getElementsByClassName('chatBody')[0]),
					void 0 === this.chatBody || null === this.chatBody)
				)
					return;
				void 0 === this.chatBody.hasListener &&
					((this.chatBody.hasListener = !0),
					this.chatBody.addEventListener(
						'DOMNodeInserted',
						function () {
							var e = this.lastChild,
								i = e.getElementsByClassName('chat-text')[0];
							if (void 0 !== i && null !== i) {
								var s = i.innerHTML;
								t.customHightlight && t.checkHighlights(t, s, i, e), t.hideImages && t.checkImages(t, s, e);
							}
							var n = e.getElementsByClassName('chat-status-message')[0];
							void 0 !== n && null !== n && (this.startTime = ((+new Date() / 1e3) | 0) + 5);
						},
						!1,
					));
			}
		}),
		(e.prototype.checkHighlights = function (t, e, a, o) {
			var h = !1;
			if (
				(h =
					!(e.indexOf('<span class="citation"') < 0) ||
					e.split(' ').some(function (e) {
						n(e.replace(/[.-\/#!$%\^&\*;:{}=\-_`~()]/g, '').replace(/\s{2,}/g, ' '), t.lstTriggers);
					}))
			) {
				var r = t.nameColor.replace(/^"(.*)"$/, '$1');
				s('#' + r);
				if (
					(void 0 !== t.chatAddonSettings.Highlight.tab &&
						t.chatAddonSettings.Highlight.tab &&
						((o.style.borderLeft = 'medium solid #' + r), (o.style.borderColor = '#' + r), (o.className = 'citation')),
					void 0 !== t.chatAddonSettings.Highlight.back &&
						t.chatAddonSettings.Highlight.back &&
						(null === t.hexNameColor && (t.hexNameColor = s('#' + r)),
						(o.style.background =
							'rgba(' + t.hexNameColor.r + ',' + t.hexNameColor.g + ',' + t.hexNameColor.b + ',0.1)'),
						(a.style.borderColor =
							'rgba(' + t.hexNameColor.r + ',' + t.hexNameColor.g + ',' + t.hexNameColor.b + ',0.1)')),
					void 0 !== t.chatAddonSettings.Highlight.text &&
						t.chatAddonSettings.Highlight.text &&
						((a.style.color = '#' + r), (a.style.borderColor = '#' + r)),
					void 0 !== t.chatAddonSettings.Notify && t.chatAddonSettings.Notify)
				) {
					var l = 'smashcast.tv';
					void 0 !== o.getElementsByClassName('chat-messages.compact .name')[0] &&
						null !== o.getElementsByClassName('chat-messages.compact .name')[0] &&
						(l = o.getElementsByClassName('name')[0].innerText);
					var g = new Date(),
						c = (+new Date() / 1e3) | 0;
					t.startTime < c &&
						t.buildNotification(l, i(g.getHours()) + ':' + i(g.getMinutes()) + ':' + i(g.getSeconds()), a.innerText);
				}
			}
		}),
		(e.prototype.checkImages = function (t, e, i) {
			e.indexOf('<image src=') < 0 && e.indexOf('class="image"') < 0
				? t.textHasImage(e) && (i.style.display = 'none')
				: (i.style.display = 'none');
		}),
		(e.prototype.textHasImage = function (t) {
			return !!(
				/chatimages.smashcast.tv/i.test(t) ||
				/media.riffsy.com/i.test(t) ||
				/giphy.com/i.test(t) ||
				/imgur.com/i.test(t) ||
				t.match(/\.(jpg|jpeg|png|gif|gifv)$/)
			);
		}),
		(e.prototype.buildNotification = function (t, e, i) {
			var s = this;
			'Notification' in window &&
				('granted' === s.Notification.permission
					? s.spawnNotification(t, e, i)
					: 'denied' !== s.Notification.permission &&
					  s.Notification.requestPermission(function (n) {
							'granted' === n && s.spawnNotification(t, e, i);
					  }));
		}),
		(e.prototype.spawnNotification = function (t, e, i) {
			if (t && e && i) {
				i.length > 45 && (i = i.substring(0, 45) + '...');
				var s = { icon: chrome.runtime.getURL('img/smashcast+-icon-180x180.png'), title: 'Mentioned by ' + t, body: i },
					n = new this.Notification('Mentioned by ' + t, s);
				setTimeout(
					function () {
						n && n.close();
					},
					5e3,
					!1,
				);
			}
		}),
		chrome.runtime.onMessage.addListener(function (t, e, i) {
			t.type &&
				'smashcast+' === t.type &&
				t.system &&
				'background' === t.system &&
				t.action &&
				'tab_change' === t.action &&
				a();
		}),
		chrome.storage.onChanged.addListener(function (t, e) {
			for (var i in t) void 0 !== d && null !== d && ((i !== d.chatAddonKey && i !== d.generalAddonKey) || a());
		});
})();
